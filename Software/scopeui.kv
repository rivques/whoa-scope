#:kivy 2.3.1
#:import Factory kivy.factory.Factory
#:import math math
#:import kivy_resources kivy.resources
<ScopeSaveDialog@Popup>:
    text_input: text_input
    file_chooser: file_chooser
    auto_dismiss: False
    title: 'Save Waveforms'
    size_hint: (0.8, 0.8)

    BoxLayout:
        orientation: 'vertical'
        padding: [15, 15, 15, 15]

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 30

            Label:
                size_hint_x: 0.15
                text: '[b]Save As:[/b]'
                font_size: app.fontsize
                markup: True

            TextInput:
                id: text_input
                multiline: False

        FileChooserListView:
            id: file_chooser
            size_hint_y: 0.6
            path: app.save_dialog_path
            on_selection: text_input.text = app.process_selection(self.selection and self.selection[0] or '')

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.15
            padding: [0, 15, 0, 0]

            Button:
                text: 'Cancel'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.root.bind_keyboard()
                    app.save_dialog_visible = False

            Button:
                text: 'Save'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.root.bind_keyboard()
                    app.save_dialog_visible = False
                    app.export_waveforms(file_chooser.path, text_input.text)

<BodeSaveDialog@Popup>:
    text_input: text_input
    file_chooser: file_chooser
    auto_dismiss: False
    title: 'Save Frequency Response'
    size_hint: (0.8, 0.8)

    BoxLayout:
        orientation: 'vertical'
        padding: [15, 15, 15, 15]

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 30

            Label:
                size_hint_x: 0.15
                text: '[b]Save As:[/b]'
                font_size: app.fontsize
                markup: True

            TextInput:
                id: text_input
                multiline: False

        FileChooserListView:
            id: file_chooser
            size_hint_y: 0.6
            path: app.save_dialog_path
            on_selection: text_input.text = app.process_selection(self.selection and self.selection[0] or '')

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.15
            padding: [0, 15, 0, 0]

            Button:
                text: 'Cancel'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.root.bind_keyboard()
                    app.save_dialog_visible = False

            Button:
                text: 'Save'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.root.bind_keyboard()
                    app.save_dialog_visible = False
                    app.export_freqresp(file_chooser.path, text_input.text)

<FileExistsAlert@Popup>:
    auto_dismiss: False
    title: 'File Already Exists'
    size_hint: (0.8, 0.8)

    BoxLayout:
        orientation: 'vertical'
        padding: [15, 15, 15, 15]

        Label:
            size_hint_y: None
            height: 30
            text: '[b]A file named "' + app.save_dialog_file + '" already exists. Do you want to replace it?[/b]'
            text_size: self.size
            font_size: app.fontsize
            markup: True

        Label:
            size_hint_y: 0.6
            text: 'The file already exists in "' + app.save_dialog_path + '". Replacing it will overwrite its contents.'
            text_size: self.width, None
            font_size: app.fontsize

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.15
            padding: [0, 15, 0, 0]

            Button:
                text: 'Cancel'
                font_size: app.fontsize
                on_release:
                    root.dismiss()

            Button:
                text: 'Replace'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.export_waveforms(app.save_dialog_path, app.save_dialog_file, True) if app.root.current == 'scope' else app.export_freqresp(app.save_dialog_path, app.save_dialog_file, True)

<OffsetWaveformLoadDialog@Popup>:
    text_input: text_input
    file_chooser: file_chooser
    auto_dismiss: False
    title: 'Load Offset Waveform'
    size_hint: (0.8, 0.8)

    BoxLayout:
        orientation: 'vertical'
        padding: [15, 15, 15, 15]

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 30

            Label:
                size_hint_x: 0.15
                text: '[b]Load From:[/b]'
                font_size: app.fontsize
                markup: True

            TextInput:
                id: text_input
                multiline: False

        FileChooserListView:
            id: file_chooser
            size_hint_y: 0.6
            path: app.save_dialog_path
            on_selection: text_input.text = app.process_selection(self.selection and self.selection[0] or '')

        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: 0.15
            padding: [0, 15, 0, 0]

            Button:
                text: 'Cancel'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.root.bind_keyboard()
                    app.save_dialog_visible = False

            Button:
                text: 'Open'
                font_size: app.fontsize
                on_release:
                    root.dismiss()
                    app.root.bind_keyboard()
                    app.save_dialog_visible = False
                    app.load_offset_waveform(file_chooser.path, text_input.text)

<DisplayLabel>
    canvas.before:
        Color:
            rgb: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2]
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 2 
            size: self.size[0] - 2, self.size[1] - 2

<DisplayLabelAlt>
    canvas.before:
        Color:
            rgba: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2], self.bkgnd_color[3]
        Rectangle:
            pos: self.pos
            size: self.size

<DisplayToggleButton>
    canvas.before:
        Color:
            rgb: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2]
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 1
            size: self.size[0] - 2, self.size[1] - 2

<ImageButton>
    canvas.before:
        Color:
            rgb: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2]
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 1
            size: self.size[0] - 2, self.size[1] - 2

<AltImageButton>
    canvas.before:
        Color:
            rgba: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2], self.bkgnd_color[3]
        Rectangle:
            pos: self.pos
            size: self.size

<ImageToggleButton>
    canvas.before:
        Color:
            rgb: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2]
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 1
            size: self.size[0] - 2, self.size[1] - 2

    canvas.after:
        Color:
            rgba: 0., 0., 0., 0.6 if self.disabled else 0.
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 1
            size: self.size[0] - 2, self.size[1] - 2

<AltImageToggleButton>
    canvas.before:
        Color:
            rgba: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2], self.bkgnd_color[3]
        Rectangle:
            pos: self.pos
            size: self.size

<ImageSpinButton>
    canvas.before:
        Color:
            rgb: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2]
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 1
            size: self.size[0] - 2, self.size[1] - 2

<LabelSpinButton>
    canvas.before:
        Color:
            rgb: self.bkgnd_color[0], self.bkgnd_color[1], self.bkgnd_color[2]
        Rectangle:
            pos: self.pos[0] + 1, self.pos[1] + 1
            size: self.size[0] - 2, self.size[1] - 2

<LinearSlider>
    snap_button: snap_button
    slider: slider
    orientation: 'horizontal'

    ImageToggleButton:
        id: snap_button
        size_hint_x: 0.1
        source: kivy_resources.resource_find('magnet_alt.png')
        state: 'down'
        on_state:
            slider.step = root.step if self.state == 'down' else 0.
            slider.value = root.minimum + root.step * round((slider.value - root.minimum) / root.step) if self.state == 'down' else slider.value

    Label:
        size_hint_x: 0.1
        text: root.label_text + app.num2str(root.value, 4) + root.units
        font_size: app.fontsize
        halign: 'center'

    Slider:
        id: slider
        size_hint_x: 0.8
        orientation: 'horizontal'
        min: root.minimum
        max: root.maximum
        value: root.initial_value
        step: root.step
        on_value:
            root.value = self.value

<LogarithmicSlider>
    snap_button: snap_button
    slider: slider
    orientation: 'horizontal'

    ImageToggleButton:
        id: snap_button
        size_hint_x: 0.1
        source: kivy_resources.resource_find('magnet_alt.png')
        state: 'down'
        on_state:
            slider.step = 1/3 if self.state == 'down' else 0.
            slider.value = root.nearest_one_two_five(slider.value) if snap_button.state == 'down' else slider.value

    Label:
        size_hint_x: 0.1
        text: root.label_text + app.num2str(root.value, 4) + root.units
        font_size: app.fontsize
        halign: 'center'

    Slider:
        id: slider
        size_hint_x: 0.8
        orientation: 'horizontal'
        min: math.log10(root.minimum)
        max: math.log10(root.maximum)
        value: math.log10(root.initial_value)
        step: 1/3
        on_value:
            root.value = math.pow(10., root.nearest_one_two_five(slider.value) if snap_button.state == 'down' else slider.value)

<DigitalControlPanel>
    led_one_button: led_one_button
    led_two_button: led_two_button
    led_three_button: led_three_button
    servo_period_slider: servo_period_slider
    d_zero_button: d_zero_button
    d_zero_mode_spinner: d_zero_mode_spinner
    d_zero_od_spinner: d_zero_od_spinner
    d_zero_freq_slider: d_zero_freq_slider
    d_zero_duty_slider: d_zero_duty_slider
    d_one_button: d_one_button
    d_one_mode_spinner: d_one_mode_spinner
    d_one_od_spinner: d_one_od_spinner
    d_one_freq_slider: d_one_freq_slider
    d_one_duty_slider: d_one_duty_slider
    d_two_button: d_two_button
    d_two_mode_spinner: d_two_mode_spinner
    d_two_od_spinner: d_two_od_spinner
    d_two_freq_slider: d_two_freq_slider
    d_two_duty_slider: d_two_duty_slider
    d_three_button: d_three_button
    d_three_mode_spinner: d_three_mode_spinner
    d_three_od_spinner: d_three_od_spinner
    d_three_freq_slider: d_three_freq_slider
    d_three_duty_slider: d_three_duty_slider

    canvas.before:
        Color:
            rgba: 0.03125, 0.03125, 0.03125, 0.8
        Rectangle:
            pos: self.pos
            size: self.size

    orientation: 'vertical'

    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 1 / 9

        ToggleButton:
            id: led_one_button
            size_hint_x: 2 / 30
            text: 'LED1'
            font_size: app.fontsize
            on_press: root.led1_callback()

        ToggleButton:
            id: led_two_button
            size_hint_x: 2 / 30
            text: 'LED2'
            font_size: app.fontsize
            on_press: root.led2_callback()

        ToggleButton:
            id: led_three_button
            size_hint_x: 2 / 30
            text: 'LED3'
            font_size: app.fontsize
            on_press: root.led3_callback()

        LogarithmicSlider:
            id: servo_period_slider
            size_hint_x: 0.8
            minimum: 500e-9
            maximum: 1.
            initial_value: 20e-3
            label_text: 'Servo\\nPeriod\\n'
            units: 's'
            on_value: root.servo_period_callback()

    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 2 / 9

        DisplayToggleButton:
            id: d_zero_button
            size_hint_x: 0.1
            text: 'D0'
            font_size: app.fontsize
            on_press: root.d0_button_callback()

        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.9

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_zero_mode_spinner
                    size_hint_x: 1 / 9 
                    text: 'OUT'
                    font_size: app.fontsize
                    values: 'OUT', 'IN', 'PWM', 'SERVO'
                    on_text: root.d0_mode_callback()

                LogarithmicSlider:
                    id: d_zero_freq_slider
                    size_hint_x: 8 / 9
                    minimum: 500
                    maximum: 500e3
                    initial_value: 1e3
                    label_text: 'Freq\\n'
                    units: 'Hz'
                    on_value: root.d0_freq_callback()

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_zero_od_spinner
                    size_hint_x: 1 / 9
                    text: 'PP'
                    font_size: app.fontsize
                    values: 'PP', 'OD'
                    on_text: root.d0_od_callback()

                LinearSlider:
                    id: d_zero_duty_slider
                    size_hint_x: 8 / 9
                    minimum: 0.
                    maximum: 100.
                    initial_value: 50.
                    step: 5.
                    label_text: 'Duty\\nCycle\\n'
                    units: '%'
                    on_value: root.d0_duty_callback()

    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 2 / 9

        DisplayToggleButton:
            id: d_one_button
            size_hint_x: 0.1
            text: 'D1'
            font_size: app.fontsize
            on_press: root.d1_button_callback()

        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.9

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_one_mode_spinner
                    size_hint_x: 1 / 9
                    text: 'OUT'
                    font_size: app.fontsize
                    values: 'OUT', 'IN', 'PWM', 'SERVO'
                    on_text: root.d1_mode_callback()

                LogarithmicSlider:
                    id: d_one_freq_slider
                    size_hint_x: 8 / 9
                    minimum: 500
                    maximum: 500e3
                    initial_value: 1e3
                    label_text: 'Freq\\n'
                    units: 'Hz'
                    on_value: root.d1_freq_callback()

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_one_od_spinner
                    size_hint_x: 1 / 9
                    text: 'PP'
                    font_size: app.fontsize
                    values: 'PP', 'OD'
                    on_text: root.d1_od_callback()

                LinearSlider:
                    id: d_one_duty_slider
                    size_hint_x: 8 / 9
                    minimum: 0.
                    maximum: 100.
                    initial_value: 50.
                    step: 5.
                    label_text: 'Duty\\nCycle\\n'
                    units: '%'
                    on_value: root.d1_duty_callback()

    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 2 / 9

        DisplayToggleButton:
            id: d_two_button
            size_hint_x: 0.1
            text: 'D2'
            font_size: app.fontsize
            on_press: root.d2_button_callback()

        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.9

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_two_mode_spinner
                    size_hint_x: 1 / 9
                    text: 'OUT'
                    font_size: app.fontsize
                    values: 'OUT', 'IN', 'PWM', 'SERVO'
                    on_text: root.d2_mode_callback()

                LogarithmicSlider:
                    id: d_two_freq_slider
                    size_hint_x: 8 / 9
                    minimum: 500
                    maximum: 500e3
                    initial_value: 1e3
                    label_text: 'Freq\\n'
                    units: 'Hz'
                    on_value: root.d2_freq_callback()

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_two_od_spinner
                    size_hint_x: 1 / 9
                    text: 'PP'
                    font_size: app.fontsize
                    values: 'PP', 'OD'
                    on_text: root.d2_od_callback()

                LinearSlider:
                    id: d_two_duty_slider
                    size_hint_x: 8 / 9
                    minimum: 0.
                    maximum: 100.
                    initial_value: 50.
                    step: 5.
                    label_text: 'Duty\\nCycle\\n'
                    units: '%'
                    on_value: root.d2_duty_callback()

    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 2 / 9

        DisplayToggleButton:
            id: d_three_button
            size_hint_x: 0.1
            text: 'D3'
            font_size: app.fontsize
            on_press: root.d3_button_callback()

        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.9

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_three_mode_spinner
                    size_hint_x: 1 / 9
                    text: 'OUT'
                    font_size: app.fontsize
                    values: 'OUT', 'IN', 'PWM', 'SERVO'
                    on_text: root.d3_mode_callback()

                LogarithmicSlider:
                    id: d_three_freq_slider
                    size_hint_x: 8 / 9
                    minimum: 500
                    maximum: 500e3
                    initial_value: 1e3
                    label_text: 'Freq\\n'
                    units: 'Hz'
                    on_value: root.d3_freq_callback()

            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5

                Spinner:
                    id: d_three_od_spinner
                    size_hint_x: 1 / 9
                    text: 'PP'
                    font_size: app.fontsize
                    values: 'PP', 'OD'
                    on_text: root.d3_od_callback()

                LinearSlider:
                    id: d_three_duty_slider
                    size_hint_x: 8 / 9
                    minimum: 0.
                    maximum: 100.
                    initial_value: 50.
                    step: 5.
                    label_text: 'Duty\\nCycle\\n'
                    units: '%'
                    on_value: root.d3_duty_callback()

<ScopeRoot>
    scope_plot: scope_plot
    meter: meter
    meter_label: meter_label
    meter_ch1_button: meter_ch1_button
    meter_ch2_button: meter_ch2_button
    scope_toolbar: scope_toolbar
    save_button: save_button
    play_pause_button: play_pause_button
    trigger_repeat_button: trigger_repeat_button
    trigger_src_button: trigger_src_button
    trigger_edge_button: trigger_edge_button
    h_cursors_button: h_cursors_button
    v_cursors_button: v_cursors_button
    xyplot: xyplot
    scope_xyplot: scope_xyplot
    swapxy_button: swapxy_button
    xy_h_cursors_button: xy_h_cursors_button
    xy_v_cursors_button: xy_v_cursors_button
    wavegen: wavegen
    wavegen_plot: wavegen_plot
    dc_button: dc_button
    sin_button: sin_button
    square_button: square_button
    triangle_button: triangle_button
    offset_adj_slider: offset_adj_slider
    offset_waveform_control_panel: offset_waveform_control_panel
    offset_waveform_plot: offset_waveform_plot
    offset_waveform_load_button: offset_waveform_load_button
    offset_waveform_play_pause_button: offset_waveform_play_pause_button
    offset_waveform_repeat_button: offset_waveform_repeat_button
    offset_waveform_interval_snap_button: offset_waveform_interval_snap_button
    offset_waveform_interval_slider: offset_waveform_interval_slider
    view_toolbar: view_toolbar
    pan_left_button: pan_left_button
    pan_up_button: pan_up_button
    pan_down_button: pan_down_button
    pan_right_button: pan_right_button
    home_view_button: home_view_button
    zoom_in_y_button: zoom_in_y_button
    zoom_out_y_button: zoom_out_y_button
    zoom_in_x_button: zoom_in_x_button
    zoom_out_x_button: zoom_out_x_button
    digital_controls: digital_controls
    digital_control_panel: digital_control_panel

    FloatLayout:

        ScopePlot:
            id: scope_plot
            size_hint: 1, 1
            pos_hint: { 'x': 0, 'y': 0 }

        AltImageButton:
            pos_hint: { 'center_x' : 0.5, 'y': 0 }
            size_hint: None, None
            size: 44, 30
            source: kivy_resources.resource_find('up.png')
            on_release:
                app.root.transition.direction = 'up'
                app.root.current = 'bode'

        FloatLayout:
            id: meter
            y_hint: 1.
            pos_hint: { 'center_x': 0.8, 'y': self.y_hint }
            size_hint: 0.3, 0.25

            canvas.before:
                Color:
                    rgba: 0.03125, 0.03125, 0.03125, 0.8
                Rectangle:
                    size: self.size
                    pos: self.pos

            DisplayLabelAlt:
                id: meter_label
                pos_hint: { 'center_x': 0.6, 'y': 0 }
                size_hint: None, None
                size: 1.1 * self.texture_size[0], self.texture_size[1]
                font_size: 0.1 * root.scope_plot.size[1]
                text: '[b][color=#FFFF00]CH1[/color]\\n[color=#00FFFF]CH2[/color][/b]'
                markup: True
                multiline: True
                bkgnd_color: 0.03125, 0.03125, 0.03125, 0

            ImageSpinButton:
                id: meter_ch1_button
                pos_hint: { 'x': 0, 'y': 0.5 }
                size_hint: 0.2, 0.5
                sources: [kivy_resources.resource_find('dc.png'), kivy_resources.resource_find('sine.png')]
                actions: [root.set_ch1_mean, root.set_ch1_rms]
                source: self.sources[0]

            ImageSpinButton:
                id: meter_ch2_button
                pos_hint: { 'x': 0, 'y': 0 }
                size_hint: 0.2, 0.5
                sources: [kivy_resources.resource_find('dc.png'), kivy_resources.resource_find('sine.png')]
                actions: [root.set_ch2_mean, root.set_ch2_rms]
                source: self.sources[0]

            AltImageToggleButton:
                pos_hint: { 'center_x': 0.5, 'top': 0 }
                size_hint: None, None
                size: 44, 30
                normal_source: kivy_resources.resource_find('down.png')
                down_source: kivy_resources.resource_find('up.png')
                source: self.normal_source
                on_state: root.toggle_meter()

        FloatLayout:
            id: scope_toolbar
            canvas.before:
                Color:
                    rgba: 0.03125, 0.03125, 0.03125, 0.8
                Rectangle:
                    size: self.size
                    pos: self.pos

            size_hint: 0.06, 1
            x_hint: 1
            pos_hint: { 'x': self.x_hint, 'y': 0 }

            BoxLayout:
                orientation: 'vertical'
                size_hint: 1, 1
                pos_hint: { 'x': 0, 'y': 0 }

                ImageButton:
                    id: save_button
                    source: kivy_resources.resource_find('save.png')
                    size_hint_y: 1 / 9
                    on_release:
                        app.save_dialog_visible = True
                        Factory.ScopeSaveDialog().open()

                ImageButton:
                    id: play_pause_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('play.png')
                    on_release: root.play_pause()

                ImageToggleButton:
                    id: trigger_repeat_button
                    source: kivy_resources.resource_find('repeat.png')
                    size_hint_y: 1 / 9
                    on_press: root.toggle_trigger_repeat()

                LabelSpinButton:
                    id: trigger_src_button
                    size_hint_y: 1 / 9
                    texts: ['[size=14]TRIGGER:[/size]\\n[b][size=32]CH1[/size][/b]', '[size=14]TRIGGER:[/size]\\n[b][size=32]CH2[/size][/b]']
                    actions: [root.set_trigger_src_ch1, root.set_trigger_src_ch2]
                    text: self.texts[0]
                    markup: True
                    text_size: self.width - 10, self.height - 10
                    valign: 'center'
                    halign: 'center'

                ImageSpinButton:
                    id: trigger_edge_button
                    sources: [kivy_resources.resource_find('rising_edge.png'), kivy_resources.resource_find('falling_edge.png')]
                    actions: [root.set_trigger_edge_rising, root.set_trigger_edge_falling]
                    source: self.sources[0]
                    size_hint_y: 1 / 9

                ImageToggleButton:
                    id: h_cursors_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('h_cursors.png')
                    on_press: root.toggle_h_cursors()

                ImageToggleButton:
                    id: v_cursors_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('v_cursors.png')
                    on_press: root.toggle_v_cursors()

                ImageButton:
                    size_hint_y: 1 / 18
                    source: kivy_resources.resource_find('up.png')
                    on_press: scope_plot.increase_gain()

                ImageButton:
                    size_hint_y: 1 / 18
                    source: kivy_resources.resource_find('down.png')
                    on_press: scope_plot.decrease_gain()

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: 1 / 9

                    ImageButton:
                        size_hint_x: 0.5
                        source: kivy_resources.resource_find('left.png')
                        on_press: scope_plot.increase_sampling_interval()

                    ImageButton:
                        size_hint_x: 0.5
                        source: kivy_resources.resource_find('right.png')
                        on_press: scope_plot.decrease_sampling_interval()

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 1
                pos_hint: { 'right': 0, 'center_y' : 0.5 }
                width: 30
                normal_source: kivy_resources.resource_find('left.png')
                down_source: kivy_resources.resource_find('right.png')
                source: self.normal_source
                on_state: root.toggle_toolbar()

        FloatLayout:
            id: xyplot
            size_hint: 0.6, 1
            right_hint: 0
            pos_hint: { 'right': self.right_hint, 'y': 0 }

            ScopeXYPlot:
                id: scope_xyplot
                size_hint: 1, 1
                pos_hint: { 'x': 0, 'y': 0 }

            BoxLayout:
                orientation: 'vertical'
                size_hint: 0.1, 3 / 9
                pos_hint: { 'x': 0.9, 'y': 6 / 9 }

                ImageButton:
                    id: swapxy_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('swapxy.png')
                    on_release: root.xyplot_swap_axes()

                ImageToggleButton:
                    id: xy_h_cursors_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('h_cursors.png')
                    on_press: root.toggle_xy_h_cursors()

                ImageToggleButton:
                    id: xy_v_cursors_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('v_cursors.png')
                    on_press: root.toggle_xy_v_cursors()

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 0.25
                pos_hint: { 'x': 1, 'center_y' : 0.875 }
                width: 30
                normal_source: kivy_resources.resource_find('right.png')
                down_source: kivy_resources.resource_find('left.png')
                source: self.normal_source
                on_state: root.toggle_xyplot()

        FloatLayout:
            id: wavegen
            size_hint: 0.6, 1
            right_hint: 0
            pos_hint: { 'right': self.right_hint, 'y': 0 }

            WavegenPlot:
                id: wavegen_plot
                size_hint: 1, 1
                pos_hint: { 'x': 0, 'y': 0 }

            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.1
                pos_hint: { 'x': 0.9, 'y': 0 }

                ImageToggleButton:
                    id: dc_button
                    source: kivy_resources.resource_find('dc.png')
                    size_hint_y: 1 / 9
                    allow_no_selection: False
                    group: 'waveshape'
                    on_press: root.set_shape('DC')

                ImageToggleButton:
                    id: sin_button
                    source: kivy_resources.resource_find('sine.png')
                    size_hint_y: 1 / 9
                    allow_no_selection: False
                    group: 'waveshape'
                    state: 'down'
                    on_press: root.set_shape('SIN')

                ImageToggleButton:
                    id: square_button
                    source: kivy_resources.resource_find('square.png')
                    size_hint_y: 1 / 9
                    allow_no_selection: False
                    group: 'waveshape'
                    on_press: root.set_shape('SQUARE')

                ImageToggleButton:
                    id: triangle_button
                    source: kivy_resources.resource_find('triangle.png')
                    size_hint_y: 1 / 9
                    allow_no_selection: False
                    group: 'waveshape'
                    on_press: root.set_shape('TRIANGLE')

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: 1 / 9

                    ImageButton:
                        size_hint_x: 0.5
                        source: kivy_resources.resource_find('left.png')
                        on_press: wavegen_plot.increase_frequency()

                    ImageButton:
                        size_hint_x: 0.5
                        source: kivy_resources.resource_find('right.png')
                        on_press: wavegen_plot.decrease_frequency()

                Slider:
                    id: offset_adj_slider
                    size_hint_y: 4 / 9
                    orientation: 'vertical'
                    value: 512
                    min: 0
                    max: 1023
                    on_value: root.update_offset_adj()

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 0.25
                pos_hint: { 'x': 1, 'center_y' : 0.625 }
                width: 30
                normal_source: kivy_resources.resource_find('right.png')
                down_source: kivy_resources.resource_find('left.png')
                source: self.normal_source
                on_state: root.toggle_wavegen()

        FloatLayout:
            id: offset_waveform_control_panel
            size_hint: 0.6, 1
            right_hint: 0
            pos_hint: { 'right': self.right_hint, 'y': 0 }

            OffsetWaveformPlot:
                id: offset_waveform_plot
                size_hint: 1, 1
                pos_hint: { 'x': 0, 'y': 0 }

            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.1
                pos_hint: { 'x': 0.9, 'y': 0 }

                ImageButton:
                    id: offset_waveform_load_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('load.png')
                    on_release:
                        app.save_dialog_visible = True
                        Factory.OffsetWaveformLoadDialog().open()

                ImageButton:
                    id: offset_waveform_play_pause_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('play.png')
                    on_release: root.offset_waveform_play_pause_button_callback()

                ImageToggleButton:
                    id: offset_waveform_repeat_button
                    source: kivy_resources.resource_find('repeat.png')
                    size_hint_y: 1 / 9
                    on_press: root.offset_waveform_repeat_button_callback()

                ImageToggleButton:
                    id: offset_waveform_interval_snap_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('magnet_alt.png')
                    state: 'down'
                    on_state:
                        offset_waveform_interval_slider.step = 0.5 if self.state == 'down' else 0.
                        offset_waveform_interval_slider.value = root.nearest_one_three(offset_waveform_interval_slider.value) if offset_waveform_interval_snap_button.state == 'down' else offset_waveform_interval_slider.value
 
                Slider:
                    id: offset_waveform_interval_slider
                    size_hint_y: 5 / 9
                    orientation: 'vertical'
                    value: math.log10(30e-3)
                    min: math.log10(100e-6)
                    max: math.log10(1)
                    step: 0.5
                    on_value: root.offset_waveform_interval_slider_callback()

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 0.25
                pos_hint: { 'x': 1, 'center_y' : 0.375 }
                width: 30
                normal_source: kivy_resources.resource_find('right.png')
                down_source: kivy_resources.resource_find('left.png')
                source: self.normal_source
                on_state: root.toggle_offset_waveform()

        FloatLayout:
            id: view_toolbar
            y_hint: 1.
            pos_hint: { 'center_x': 0.42, 'y': self.y_hint}
            size_hint: 0.24, 2 / 9

            canvas.before:
                Color:
                    rgba: 0.03125, 0.03125, 0.03125, 0.8
                Rectangle:
                    size: self.size
                    pos: self.pos

            BoxLayout:
                orientation: 'vertical'
                pos_hint: { 'x': 0, 'y': 0 }
                size_hint: 1, 1

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: 0.5

                    ImageButton:
                        id: pan_left_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('left.png')
                        on_release: root.pan_left()

                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_x: 0.25

                        ImageButton:
                            id: pan_up_button
                            size_hint_y: 0.5
                            source: kivy_resources.resource_find('up.png')
                            on_release: root.pan_up()

                        ImageButton:
                            id: pan_down_button
                            size_hint_y: 0.5
                            source: kivy_resources.resource_find('down.png')
                            on_release: root.pan_down()

                    ImageButton:
                        id: pan_right_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('right.png')
                        on_release: root.pan_right()

                    ImageButton:
                        id: home_view_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('home.png')
                        on_release: root.home_view()

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: 0.5

                    ImageButton:
                        id: zoom_in_y_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('zoom_in_y.png')
                        on_release: root.zoom_in_y()

                    ImageButton:
                        id: zoom_out_y_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('zoom_out_y.png')
                        on_release: root.zoom_out_y()

                    ImageButton:
                        id: zoom_in_x_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('zoom_in_x.png')
                        on_release: root.zoom_in_x()

                    ImageButton:
                        id: zoom_out_x_button
                        size_hint_x: 0.25
                        source: kivy_resources.resource_find('zoom_out_x.png')
                        on_release: root.zoom_out_x()

            AltImageToggleButton:
                pos_hint: { 'center_x': 0.5, 'top': 0 }
                size_hint: None, None
                size: 44, 30
                normal_source: kivy_resources.resource_find('down.png')
                down_source: kivy_resources.resource_find('up.png')
                source: self.normal_source
                on_state: root.toggle_view_toolbar()

        FloatLayout:
            id: digital_controls
            size_hint: 0.6, 1
            right_hint: 0
            pos_hint: { 'right': self.right_hint, 'y': 0 }

            DigitalControlPanel:
                id: digital_control_panel
                size_hint: 1, 1
                pos_hint: { 'x': 0, 'y': 0 }

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 0.25
                pos_hint: { 'x': 1, 'center_y' : 0.125 }
                width: 30
                normal_source: kivy_resources.resource_find('right.png')
                down_source: kivy_resources.resource_find('left.png')
                source: self.normal_source
                on_state: root.toggle_digital_controls()

<BodeRoot>
    bode_plot: bode_plot
    bode_toolbar: bode_toolbar
    save_button: save_button
    play_stop_button: play_stop_button
    trigger_repeat_button: trigger_repeat_button
    pointmarkers_button: pointmarkers_button
    bode_controls: bode_controls
    start_freq_slider: start_freq_slider
    end_freq_slider: end_freq_slider
    num_points_slider: num_points_slider
    amplitude_slider: amplitude_slider
    offset_slider: offset_slider

    FloatLayout:
        size_hint: 1, 1
        pos_hint: { 'x': 0, 'y': 0 }

        BodePlot:
            id: bode_plot
            size_hint: 1, 1
            pos_hint: { 'x': 0, 'y': 0 }

        AltImageButton:
            pos_hint: { 'center_x': 0.5, 'top': 1 }
            size_hint: None, None
            size: 44, 30
            source: kivy_resources.resource_find('down.png')
            on_release:
                app.root.transition.direction = 'down'
                app.root.current = 'scope'

        FloatLayout:
            id: bode_toolbar
            canvas.before:
                Color:
                    rgba: 0.03125, 0.03125, 0.03125, 0.8
                Rectangle:
                    size: self.size
                    pos: self.pos

            size_hint: 0.06, 4 / 9 
            x_hint: 1
            pos_hint: { 'x': self.x_hint, 'y': 5 / 9 }

            BoxLayout:
                orientation: 'vertical'
                size_hint: 1, 1
                pos_hint: { 'x': 0, 'y': 0 }

                ImageButton:
                    id: save_button
                    source: kivy_resources.resource_find('save.png')
                    size_hint_y: 1 / 9
                    on_release:
                        app.save_dialog_visible = True
                        Factory.BodeSaveDialog().open()

                ImageButton:
                    id: play_stop_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('play.png')
                    on_release: root.play_stop()

                ImageToggleButton:
                    id: trigger_repeat_button
                    source: kivy_resources.resource_find('repeat.png')
                    size_hint_y: 1 / 9

                ImageToggleButton:
                    id: pointmarkers_button
                    size_hint_y: 1 / 9
                    source: kivy_resources.resource_find('pointmarkers.png')
                    on_press: root.toggle_pointmarkers()

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 1
                pos_hint: { 'right': 0, 'center_y' : 0.5 }
                width: 30
                normal_source: kivy_resources.resource_find('left.png')
                down_source: kivy_resources.resource_find('right.png')
                source: self.normal_source
                on_state: root.toggle_bode_toolbar()

        FloatLayout:
            id: bode_controls
            size_hint: 0.6, 1
            right_hint: 0
            pos_hint: { 'right': self.right_hint, 'y': 0 }

            canvas.before:
                Color:
                    rgba: 0.03125, 0.03125, 0.03125, 0.8
                Rectangle:
                    pos: self.pos
                    size: self.size

            LogarithmicSlider:
                id: start_freq_slider
                size_hint: 1, 1 / 9
                pos_hint: { 'x': 0, 'y': 8 / 9 }
                orientation: 'horizontal'
                minimum: 20e-3
                maximum: 200e3
                initial_value: 1.
                label_text: 'Start\\nFreq\\n'
                units: 'Hz'

            LogarithmicSlider:
                id: end_freq_slider
                size_hint: 1, 1 / 9
                pos_hint: { 'x': 0, 'y': 7 / 9 }
                orientation: 'horizontal'
                minimum: 20e-3
                maximum: 200e3
                initial_value: 100e3
                label_text: 'End\\nFreq\\n'
                units: 'Hz'

            LinearSlider:
                id: num_points_slider
                size_hint: 1, 1 / 9
                pos_hint: { 'x': 0, 'y': 6 / 9 }
                orientation: 'horizontal'
                minimum: 1
                maximum: 201
                step: 10
                min_step: 1
                initial_value: 101
                label_text: 'Points\\n'
                units: ''

            LinearSlider:
                id: amplitude_slider
                size_hint: 1, 1 / 9
                pos_hint: { 'x': 0, 'y': 5 / 9 }
                orientation: 'horizontal'
                minimum: 0.
                maximum: 2.5
                step: 50e-3
                initial_value: 1.
                label_text: 'Amp\\n'
                units: 'V'

            LinearSlider:
                id: offset_slider
                size_hint: 1, 1 / 9
                pos_hint: { 'x': 0, 'y': 4 / 9 }
                orientation: 'horizontal'
                minimum: 0.
                maximum: 5.
                step: 0.5
                initial_value: 2.5
                label_text: 'Offset\\n'
                units: 'V'

            AltImageToggleButton:
                size_hint_x: None
                size_hint_y: 1
                pos_hint: { 'x': 1, 'center_y' : 0.5 }
                width: 30
                normal_source: kivy_resources.resource_find('right.png')
                down_source: kivy_resources.resource_find('left.png')
                source: self.normal_source
                on_state: root.toggle_bode_controls()

<RootWidget>
    scope: scope_root
    bode: bode_root

    ScopeRoot:
        id: scope_root
        name: 'scope'

    BodeRoot:
        id: bode_root
        name: 'bode'